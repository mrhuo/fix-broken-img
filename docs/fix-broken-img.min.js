function encodeHTML(str){if(typeof str !== 'string')return str;return str .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}class FixBrokenImg extends HTMLElement{constructor(){super();this.attachShadow({mode:'open'});this._init();}static get observedAttributes(){return ['src','alt','background-color','text-color'];}_init(){this._render();this._setupEventListeners();}_render(){const backgroundColor = this.getAttribute('background-color')|| '#f5f5f5';const textColor = this.getAttribute('text-color')|| '#666';const altText = this.getAttribute('alt')||(window.FIX_BROKEN_IMG_DEFAULT_TEXT || 'ðŸ˜Ÿ å›¾ç‰‡åŠ è½½å¤±è´¥');this.shadowRoot.innerHTML = ` <style>:host{display:inline-block;position:relative;overflow:hidden;}.image-container{position:relative;width:100%;height:100%;}.image{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 0.3s ease;}.image.loaded{opacity:1;}.fallback{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background-color:${backgroundColor};color:${textColor};font-family:Arial,sans-serif;font-size:14px;opacity:0;transition:opacity 0.3s ease;pointer-events:none;}.fallback.show{opacity:1;pointer-events:auto;}.loading{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background-color:rgba(245,245,245,0.8);opacity:0;transition:opacity 0.3s ease;}.loading.show{opacity:1;}.loading::after{content:'';width:20px;height:20px;border:2px solid #ddd;border-top:2px solid #666;border-radius:50%;animation:spin 1s linear infinite;}@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style> <div class="image-container"> <img class="image" src="" alt=""> <div class="loading"></div> <div class="fallback">${altText}</div> </div> `;}_setupEventListeners(){const img = this.shadowRoot.querySelector('.image');const loading = this.shadowRoot.querySelector('.loading');const fallback = this.shadowRoot.querySelector('.fallback');img.addEventListener('load',()=>{img.classList.add('loaded');loading.classList.remove('show');fallback.classList.remove('show');});img.addEventListener('error',()=>{loading.classList.remove('show');fallback.classList.add('show');});img.addEventListener('loadstart',()=>{loading.classList.add('show');});}connectedCallback(){this._loadImage();}attributeChangedCallback(name,oldValue,newValue){if(oldValue !== newValue){if(name === 'src'){this._loadImage();}else if(name === 'alt'){this._updateAltText();}else if(name === 'background-color' || name === 'text-color'){this._updateStyles();}}}_loadImage(){const src = this.getAttribute('src');const img = this.shadowRoot.querySelector('.image');const loading = this.shadowRoot.querySelector('.loading');const fallback = this.shadowRoot.querySelector('.fallback');if(!src){loading.classList.remove('show');fallback.classList.add('show');return;}img.classList.remove('loaded');loading.classList.add('show');fallback.classList.remove('show');img.src = src;img.alt = this.getAttribute('alt')|| '';}_updateAltText(){const altText = this.getAttribute('alt')||(window.FIX_BROKEN_IMG_DEFAULT_TEXT || 'ðŸ˜Ÿ å›¾ç‰‡åŠ è½½å¤±è´¥');const fallback = this.shadowRoot.querySelector('.fallback');fallback.textContent = altText;}_updateStyles(){const backgroundColor = this.getAttribute('background-color')|| '#f5f5f5';const textColor = this.getAttribute('text-color')|| '#666';const fallback = this.shadowRoot.querySelector('.fallback');fallback.style.backgroundColor = backgroundColor;fallback.style.color = textColor;}reload(){this._loadImage();}setSrc(src){this.setAttribute('src',src);}setAlt(alt){this.setAttribute('alt',alt);}}customElements.define('fix-broken-img',FixBrokenImg);function initFixBrokenImg(config ={}){const{background = '#f5f5f5',textColor = '#666',defaultText = 'ðŸ˜Ÿ å›¾ç‰‡åŠ è½½å¤±è´¥',autoConvert = true}= config;if(defaultText !== 'ðŸ˜Ÿ å›¾ç‰‡åŠ è½½å¤±è´¥'){window.FIX_BROKEN_IMG_DEFAULT_TEXT = defaultText;}if(!autoConvert)return;const observer = new MutationObserver((mutations)=>{mutations.forEach((mutation)=>{mutation.addedNodes.forEach((node)=>{if(node.nodeType === Node.ELEMENT_NODE){const images = node.querySelectorAll ? node.querySelectorAll('img'):[];images.forEach(img =>{if(!img.closest('fix-broken-img')){_convertToFixBrokenImg(img,background,textColor);}});}});});});observer.observe(document.body,{childList:true,subtree:true});const processExistingImages =()=>{const images = document.querySelectorAll('img');images.forEach(img =>{if(!img.closest('fix-broken-img')){_convertToFixBrokenImg(img,background,textColor);}});};if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',processExistingImages);}else{processExistingImages();}}function _copyComputedStyles(source,target){const computedStyle = window.getComputedStyle(source);const importantStyles = [ "width","height","margin","padding","border","border-radius","position","float","vertical-align",];importantStyles.forEach((prop)=>{const value = computedStyle.getPropertyValue(prop);if(value && value !== "auto" && value !== "none" && value !== "0px"){target.style.setProperty(prop,value);}});}function _convertToFixBrokenImg(img,background,textColor){if(img.closest('fix-broken-img')){return;}const wrapper = document.createElement('fix-broken-img');Array.from(img.attributes).forEach(attr =>{try{wrapper.setAttribute(attr.name,attr.value);}catch(error){console.warn(`æ— æ³•è®¾ç½®å±žæ€§ "${attr.name}"ï¼Œå€¼:"${attr.value}"`,error);const safeValue = encodeHTML(attr.value);wrapper.setAttribute(attr.name,safeValue);}});if(background && background !== '#f5f5f5'){wrapper.setAttribute('background-color',background);}if(textColor && textColor !== '#666'){wrapper.setAttribute('text-color',textColor);}wrapper.style.cssText = img.style.cssText;if(img.complete){_copyComputedStyles(img,wrapper);img.parentNode.replaceChild(wrapper,img);}else{img.addEventListener('load',()=>{_copyComputedStyles(img,wrapper);img.parentNode.replaceChild(wrapper,img);},{once:true});setTimeout(()=>{_copyComputedStyles(img,wrapper);img.parentNode.replaceChild(wrapper,img);},1000);}}function autoInitFixBrokenImg(){const scriptElement = document.getElementById('fix-broken-img');const config ={};if(scriptElement){config.background = scriptElement.dataset.background || '#f5f5f5';config.textColor = scriptElement.dataset.textColor || '#666';config.defaultText = scriptElement.dataset.defaultText || 'ðŸ˜Ÿ å›¾ç‰‡åŠ è½½å¤±è´¥';config.autoConvert = scriptElement.dataset.autoConvert !== 'false';}else{config.background = '#f5f5f5';config.textColor = '#666';config.defaultText = 'ðŸ˜Ÿ å›¾ç‰‡åŠ è½½å¤±è´¥';config.autoConvert = true;}initFixBrokenImg(config);}if(typeof window !== 'undefined'){window.FixBrokenImg = FixBrokenImg;window.initFixBrokenImg = initFixBrokenImg;window.autoInitFixBrokenImg = autoInitFixBrokenImg;}if(typeof window !== 'undefined'){if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',()=>{autoInitFixBrokenImg();});}else{autoInitFixBrokenImg();}}